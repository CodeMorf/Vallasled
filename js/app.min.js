(function(){
  // 1) Cargar web settings y aplicar colores/logo
  (async function(){
    try{
      const r=await fetch('/api/web_settings/api.php?keys=asset_version,colors.primary,colors.secondary,logo.url',{cache:'no-store'});
      if(r.ok){
        const j=await r.json();
        const data=j?.data||{};
        if(data['colors.primary']) document.documentElement.style.setProperty('--color-primary', data['colors.primary']);
        if(data['colors.secondary']) document.documentElement.style.setProperty('--color-secondary', data['colors.secondary']);
        // opcional: actualizar logo si tienes <img id="siteLogo">
        if(data['logo.url'] && document.getElementById('siteLogo')) document.getElementById('siteLogo').src=data['logo.url'];
      }
    }catch(e){}
  })();

  const ROOT=(document.querySelector('meta[name=site-root]')?.content||location.origin).replace(/\/+$/,'');
  const $dest=document.getElementById('destacadas-strip');
  const $destEmpty=document.getElementById('destacadas-empty');
  const $grid=document.getElementById('vallas-grid');
  const $pag=document.getElementById('pagination');
  const $loading=document.getElementById('loading-row');
  const $empty=document.getElementById('empty-row');

  const $q=document.getElementById('q'), $tipo=document.getElementById('tipo'), $zona=document.getElementById('zona');
  const $prov=document.getElementById('provincia'), $disp=document.getElementById('disponible');
  const $btnBuscar=document.getElementById('btnBuscar'), $btnLimpiar=document.getElementById('btnLimpiar');

  const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const money=n=>{const x=Number(n);return isFinite(x)?'RD$ '+x.toLocaleString('es-DO'):'';}
  const isLED=v=>String(v?.tipo||'').toLowerCase()==='led';
  const ledFirst=arr=>arr.slice().sort((a,b)=>(isLED(b)-isLED(a)));

  function cardHTML(v,{ad=false}={}){
    const img=(Array.isArray(v.media)&&v.media[0]?.url)?v.media[0].url:'';
    const tipoRaw=String(v?.tipo||'').toLowerCase();
    const tipo=(v.tipo||'-').toString().toUpperCase();
    const precio=(v.precio!=null)?money(v.precio):'';
    const disp=(String(v.disponible)=='1');
    const href=(tipoRaw==='led')?(`/detalles-led/index.php?id=${encodeURIComponent(v.id)}`):(`/detalles-vallas/index.php?id=${encodeURIComponent(v.id)}`);
    const badge=(tipoRaw==='led')?`<span class="live-badge">LIVE</span>`:'';
    return `
      <article class="card" data-id="${esc(v.id)}">
        <a class="block" href="${href}" aria-label="Ver ${esc(v.nombre||'Valla')}">
          <div class="relative aspect-[16/9] bg-gray-100">
            ${img?`<img src="${esc(img)}" alt="" class="w-full h-full object-cover">`:`<div class="w-full h-full"></div>`}
            ${badge}
          </div>
        </a>
        <div class="p-4">
          <div class="text-xs text-gray-500 flex items-center gap-2">
            <span>${esc(tipo)}</span>${v.zona?`<span>· ${esc(v.zona)}</span>`:''}${v.medida?`<span>· ${esc(v.medida)}</span>`:''}
          </div>
          <h3 class="font-bold mt-1 line-clamp-1"><a href="${href}">${esc(v.nombre??'Sin nombre')}</a></h3>
          <div class="flex items-center justify-between mt-2">
            ${precio?`<div style="color:#dc2626;font-weight:800">${esc(precio)}</div>`:'<div></div>'}
            <span class="text-xs px-2 py-1 rounded-lg" style="background:${disp?'#d1fae5':'#ffe4e6'};color:${disp?'#065f46':'#9f1239'}">
              ${disp?'Disponible':'No disponible'}
            </span>
          </div>
          <div class="mt-3 flex items-center btn-row">
            <a href="/api/carritos/api.php?a=add&id=${encodeURIComponent(String(v.id||''))}" class="btn-xs bg-red-600 text-white border-0 add-to-cart" data-id="${esc(v.id)}">Añadir</a>
            <a href="${href}" class="btn-xs view-btn">Ver</a>
            <a href="/calendario/index.php?valla_id=${encodeURIComponent(String(v.id||''))}" class="btn-xs primary" title="Ver calendario">Calendario</a>
            <button type="button" class="select-valla btn-xs" data-id="${esc(v.id)}">Seleccionar</button>
          </div>
        </div>
      </article>`;
  }

  // Destacada
  (async function loadDestacadas(){
    try{
      const rIds=await fetch(`${ROOT}/api/destacados/api.php?only_ids=1&limit=1`,{cache:'no-store'});
      if(!rIds.ok) throw 0;
      const jIds=await rIds.json(); const ids=Array.isArray(jIds?.items)?jIds.items:[];
      if(!ids.length){$destEmpty?.classList.remove('hidden');return;}
      const vid=ids[0];
      let v=null;
      try{
        const r1=await fetch(`${ROOT}/api/buscador.php?id=${encodeURIComponent(vid)}`,{cache:'no-store'});
        if(r1.ok){const j1=await r1.json(); v=j1?.item||(Array.isArray(j1?.items)?j1.items.find(x=>String(x.id)==String(vid)):null);}
      }catch{}
      if(!v){
        try{
          const r2=await fetch(`${ROOT}/api/buscador.php?ids=${encodeURIComponent(vid)}`,{cache:'no-store'});
          if(r2.ok){const j2=await r2.json(); v=Array.isArray(j2?.items)?j2.items.find(x=>String(x.id)==String(vid)):null;}
        }catch{}
      }
      if(!$dest) return;
      $dest.innerHTML = v ? cardHTML(v,{ad:true}) : '';
      if(!v) $destEmpty?.classList.remove('hidden');
    }catch{$destEmpty?.classList.remove('hidden');}
  })();

  // Catálogo
  let state={page:1,per_page:12,total:0,pages:1};
  async function loadVallas(page=1){
    $loading?.classList.remove('hidden'); $empty?.classList.add('hidden'); if($grid) $grid.innerHTML=''; if($pag) $pag.innerHTML='';
    state.page=page;

    const qs=new URLSearchParams();
    if($q?.value.trim()) qs.set('q',$q.value.trim());
    if($tipo?.value) qs.set('tipo',$tipo.value);
    if($zona?.value) qs.set('zona',$zona.value);
    if($prov?.value) qs.set('provincia',$prov.value);
    if($disp && $disp.value!=='') qs.set('disponible',$disp.value);
    qs.set('page', String(state.page)); qs.set('per_page', String(state.per_page));

    let res=await fetch(`${ROOT}/api/buscador.php?${qs.toString()}`, {cache:'no-store'}).catch(()=>null);
    $loading?.classList.add('hidden');
    if(!res||!res.ok){$empty?.classList.remove('hidden');return;}
    const j=await res.json().catch(()=>null);
    let items=j?.items||[];
    if(!items.length){$empty?.classList.remove('hidden');return;}

    items=ledFirst(items);

    if(($zona&&$zona.options.length<=1)||($prov&&$prov.options.length<=1)){
      const zonas=new Set(),provs=new Set();
      items.forEach(v=>{if(v.zona) zonas.add(String(v.zona)); if(v.provincia_nombre) provs.add(String(v.provincia_nombre)); else if(v.provincia_id) provs.add(String(v.provincia_id));});
      if($zona&&$zona.options.length<=1){zonas.forEach(z=>{const o=document.createElement('option');o.value=z;o.textContent=z;$zona.appendChild(o);});}
      if($prov&&$prov.options.length<=1){provs.forEach(p=>{const o=document.createElement('option');o.value=p;$prov.appendChild(o);});}
    }

    if($grid) $grid.innerHTML = items.map(v=>cardHTML(v)).join('');

    const total=Number(j?.total??0);
    const pages=Number(j?.pages??(items.length<state.per_page?state.page:state.page+1));
    state.total=total; state.pages=Math.max(1,pages);

    const mkBtn=(p,label,dis=false)=>`<button ${dis?'disabled':''} data-p="${p}" class="btn-xs">${label}</button>`;
    const prevDis=state.page<=1, nextDis=state.page>=state.pages;
    const jump=Math.max(1,state.page-2), end=Math.min(state.pages,state.page+2);
    let nums=''; for(let i=jump;i<=end;i++){nums+=`<button data-p="${i}" class="btn-xs ${i===state.page?'primary':''}">${i}</button>`;}
    if($pag){
      $pag.innerHTML=mkBtn(state.page-1,'« Anterior',prevDis)+nums+mkBtn(state.page+1,'Siguiente »',nextDis);
      $pag.querySelectorAll('button[data-p]').forEach(b=>b.addEventListener('click',()=>{const p=Number(b.dataset.p||'1');if(!isNaN(p)) loadVallas(p);}));
    }
  }

  document.getElementById('toggleFiltros')?.addEventListener('click', async ()=>{
    const bar=document.getElementById('filters-bar');
    const willHide=bar&&!bar.classList.contains('hidden');
    if(bar) bar.classList.toggle('hidden', willHide);
    try{await fetch(`${ROOT}/api/ocultar-buscador/api.php`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hide:willHide?1:0}),credentials:'same-origin'})}catch{}
  });
  document.addEventListener('keyup', ev=>{ if(ev.key==='Enter') loadVallas(1); });
  document.getElementById('btnBuscar')?.addEventListener('click',()=>loadVallas(1));
  document.getElementById('btnLimpiar')?.addEventListener('click',()=>{$q.value='';$tipo.value='';$zona.value='';$prov.value='';$disp.value='';loadVallas(1);});

  document.addEventListener('click',(e)=>{
    const add=e.target.closest?.('.add-to-cart');
    if(add){
      e.preventDefault();
      const id=parseInt(add.dataset.id||'0',10); if(!id) return;
      fetch(`/api/carritos/api.php?a=add&id=${encodeURIComponent(id)}`,{credentials:'include'})
        .then(r=>r.json().catch(()=>({}))).then(()=>{ if(typeof window.cartCount==='function') window.cartCount(); });
    }
    const pick=e.target.closest?.('.select-valla');
    if(pick){
      e.preventDefault();
      const id=parseInt(pick.dataset.id||'0',10); if(!id) return;
      pick.classList.toggle('sel'); pick.closest('.card')?.classList.toggle('sel-on');
    }
  });

  loadVallas(1);
})();
